# Docker Compose Override íŒŒì¼ (ì‚¬ë‚´ í™˜ê²½ìš©)
#
# ì‚¬ìš©ë²•:
# 1. ì´ íŒŒì¼ì„ docker-compose.override.ymlë¡œ ë³µì‚¬
# 2. íšŒì‚¬ í™˜ê²½ì— ë§ê²Œ ìˆ˜ì • (proxy, DB ì •ë³´ ë“±)
# 3. gitì— ì¶”ê°€í•˜ì§€ ì•ŠìŒ (.gitignoreì— ì´ë¯¸ ì¶”ê°€ë¨)
#
# Docker ComposeëŠ” ìë™ìœ¼ë¡œ docker-compose.override.ymlì„ mergeí•©ë‹ˆë‹¤
# ì‚¬ì™¸ ê¸°ë³¸ê°’(docker-compose.yml) + ì‚¬ë‚´ ì„¤ì •(docker-compose.override.yml) = ìµœì¢… í™˜ê²½

version: '3.8'

services:
  # ============================================================
  # ì‚¬ë‚´ PostgreSQL (íšŒì‚¬ ë‚´ë¶€ DB ì„œë²„ ì‚¬ìš© ì‹œ)
  # ============================================================
  # db:
  #   # ì‚¬ë‚´ DB ì„œë²„ ì‚¬ìš© ì‹œ ì»¨í…Œì´ë„ˆ ë¹„í™œì„±í™”
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '0'
  #         memory: 0B
  #   # ë˜ëŠ” ì•„ë˜ì²˜ëŸ¼ ëª¨ë‘ ì œê±°:
  #   # (docker-compose.override.ymlì—ì„œ service ì œê±°ëŠ” ë¶ˆê°€ëŠ¥í•˜ë¯€ë¡œ ìœ„ ë°©ë²• ì‚¬ìš©)

  backend:
    build:
      # ë¹Œë“œ ì‹œì  ì„¤ì • (ì‚¬ë‚´ í™˜ê²½)
      args:
        # íšŒì‚¬ PyPI ë¯¸ëŸ¬ (ì˜ˆì‹œ)
        PIP_INDEX_URL: http://pypi.company.internal:8080/simple
        PIP_EXTRA_INDEX_URL: http://mirror.company.internal:8080/pypi/simple

        # íšŒì‚¬ í”„ë¡ì‹œ
        HTTP_PROXY: http://proxy.company.com:8080
        HTTPS_PROXY: http://proxy.company.com:8080
        NO_PROXY: localhost,127.0.0.1,.company.com,db

    environment:
      # ì‚¬ë‚´ DB ì„œë²„ ì—°ê²° (ì™¸ë¶€ ì„œë²„ ì‚¬ìš©)
      DATABASE_URL: postgresql://internal_user:${DB_PASSWORD}@postgres.company.internal:5432/sleassem

      # ì‚¬ë‚´ í™˜ê²½ í‘œì‹œ
      ENVIRONMENT: production
      LOG_LEVEL: WARNING

      # ì‚¬ë‚´ í”„ë¡ì‹œ
      HTTP_PROXY: http://proxy.company.com:8080
      HTTPS_PROXY: http://proxy.company.com:8080
      NO_PROXY: localhost,127.0.0.1,.company.com

    ports:
      # ì‚¬ë‚´: í¬íŠ¸ ë…¸ì¶œ ì œê±° (ë‚´ë¶€ íŠ¸ë˜í”½ë§Œ)
      - "8000:8000"  # í•„ìš”ì‹œ ì œê±°

    volumes:
      # ì‚¬ë‚´: ì‹¤ì‹œê°„ ì½”ë“œ ë³€ê²½ ë¹„í™œì„±í™” (Production í™˜ê²½)
      # - .:/app  # ì œê±° (ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ì½”ë“œë§Œ ì‚¬ìš©)
      # ìœ„ ë¼ì¸ì„ ì£¼ì„ ì²˜ë¦¬í•˜ë ¤ë©´ ì•„ë˜ì²˜ëŸ¼ override:
      - /app:/app  # read-onlyë¡œ ì„¤ì •í•˜ê±°ë‚˜ ì œê±°

    # ì‚¬ë‚´: í”„ë¡œë•ì…˜ ëª¨ë“œ (ìë™ ë‹¤ì‹œë¡œë“œ ë¹„í™œì„±í™”)
    command: >
      sh -c "
        echo 'ğŸ”„ ë°ì´í„°ë² ì´ìŠ¤ ëŒ€ê¸°ì¤‘...';
        sleep 5;
        echo 'ğŸ“¦ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰...';
        alembic upgrade head;
        echo 'ğŸš€ Uvicorn ì„œë²„ ì‹œì‘ (í”„ë¡œë•ì…˜ ëª¨ë“œ)...';
        python -m uvicorn src.backend.main:app
          --host 0.0.0.0
          --port 8000
          --workers 4
      "

    depends_on:
      # ì‚¬ë‚´: ë¡œì»¬ DB ì»¨í…Œì´ë„ˆ ë¹„í™œì„±í™” (ì™¸ë¶€ DB ì‚¬ìš©)
      # db:
      #   condition: service_healthy  # ì œê±°

    restart: always  # ì‚¬ë‚´: ìë™ ì¬ì‹œì‘

# ============================================================
# ì‚¬ë‚´ ì„¤ì • (í•„ìš”ì‹œ)
# ============================================================
# ì‚¬ë‚´ Redis (ìˆìœ¼ë©´ í™œì„±í™”)
# redis:
#   image: redis:7-alpine
#   container_name: slea-redis-company
#   environment:
#     - REDIS_PASSWORD=${REDIS_PASSWORD}
#   ports:
#     - "6379:6379"  # í•„ìš”ì‹œ
#   networks:
#     - slea-network
#   restart: always
