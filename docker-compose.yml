services:
  db:
    image: postgres:15-alpine
    container_name: slea-db

    environment:
      POSTGRES_DB: sleassem_dev
      POSTGRES_USER: slea_user
      POSTGRES_PASSWORD: change_me_dev_password
      POSTGRES_HOST_AUTH_METHOD: trust
      TZ: Asia/Seoul
      PGTZ: Asia/Seoul
    volumes:
      - postgres_data:/var/lib/postgresql/data

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U slea_user -d sleassem_dev"]
      interval: 300s
      timeout: 5s
      retries: 5
      start_period: 10s

    networks:
      - slea-network

    restart: unless-stopped

  backend:
    # ë¹Œë“œ ì„¤ì •
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PIP_INDEX_URL: ${PIP_INDEX_URL:-}
        PIP_EXTRA_INDEX_URL: ${PIP_EXTRA_INDEX_URL:-}
        HTTP_PROXY: ${HTTP_PROXY:-}
        HTTPS_PROXY: ${HTTPS_PROXY:-}
        NO_PROXY: ${NO_PROXY:-db,localhost,127.0.0.1}

    container_name: slea-backend

    environment:
      # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°
      # ì£¼ì˜: 'db' í˜¸ìŠ¤íŠ¸ëª…ì€ Docker ì»¨í…Œì´ë„ˆ ë„¤íŠ¸ì›Œí¬ ë‚´ë¶€ ì´ë¦„
      # Docker ë‚´ë¶€ì—ì„œ PostgreSQL ì»¨í…Œì´ë„ˆëŠ” í•­ìƒ 5432ì—ì„œ ë¦¬ìŠ¤ë‹
      # í˜¸ìŠ¤íŠ¸ì˜ í¬íŠ¸ 5433 ë§¤í•‘ì€ ì—¬ê¸°ì„œ ë¶ˆí•„ìš” (ì»¨í…Œì´ë„ˆ ë‚´ë¶€ í†µì‹ )
      DATABASE_URL: postgresql://${DB_USER:-slea_user}:${DB_PASSWORD:-change_me_dev_password}@db:5432/${DB_NAME:-sleassem_dev}

      HOST: 127.0.0.1
      PORT: 8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      ENVIRONMENT: ${ENVIRONMENT:-development}

      # Python ì„¤ì •
      PYTHONUNBUFFERED: 1
      PYTHONDONTWRITEBYTECODE: 1
      PYTHONPATH: /app

      # íƒ€ì„ì¡´
      TZ: Asia/Seoul

      # JWT Configuration (REQ-B-A1)
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-your-secret-key-change-in-production}

      # OIDC / Azure AD Configuration (REQ-B-A1)
      # ê°œë°œ: .envì—ì„œ ìë™ ë¡œë“œ (your-azure-app-id ì‚¬ìš© ì‹œ mock ëª¨ë“œ)
      # í”„ë¡œë•ì…˜: ì‹¤ì œ Azure ìê²©ì¦ëª…ìœ¼ë¡œ êµì²´
      OIDC_TENANT_ID: ${OIDC_TENANT_ID:-common}
      OIDC_CLIENT_ID: ${OIDC_CLIENT_ID:-your-azure-app-id}
      OIDC_CLIENT_SECRET: ${OIDC_CLIENT_SECRET:-your-azure-client-secret}
      OIDC_REDIRECT_URI: ${OIDC_REDIRECT_URI:-http://localhost:3000/auth/callback}

      # LLM Configuration (Docker container â†’ Host LiteLLM)
      # host.docker.internal: í˜¸ìŠ¤íŠ¸ì˜ localhostì— ì ‘ê·¼í•˜ê¸° ìœ„í•œ íŠ¹ìˆ˜ DNSëª…
      # ì°¸ê³ : Linuxì—ì„œëŠ” 172.17.0.1 ë˜ëŠ” host.docker.internal ì‚¬ìš©
      USE_LITE_LLM: "True"
      LITELLM_BASE_URL: ${LITELLM_BASE_URL:-http://host.docker.internal:4444/v1}
      LITELLM_API_KEY: ${LITELLM_API_KEY:-sk-4444}
      LITELLM_MODEL: ${LITELLM_MODEL:-gemini-2.0-flash}

    ports:
      - "8001:8000"

    depends_on:
      db:
        condition: service_healthy

    networks:
      - slea-network

    restart: unless-stopped

    command:
      - /bin/sh
      - -c
      - |
        echo 'ğŸ”„ Waiting for database...';
        sleep 5;
        echo 'ğŸš€ Starting Uvicorn server...';
        python -m uvicorn src.backend.main:app --host 0.0.0.0 --port 8000

networks:
  slea-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
